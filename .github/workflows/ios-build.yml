# GitHub Actions workflow for building iOS IPA
# 
# 使用说明:
# 1. 将此文件放在 .github/workflows/ 目录下
# 2. 在 GitHub 仓库设置中配置 Secrets (见下方说明)
# 3. Push 代码或手动触发构建
#
# 需要配置的 Secrets:
# - APPLE_CERTIFICATE_BASE64: iOS 发布证书 (.p12) 的 Base64 编码
# - APPLE_CERTIFICATE_PASSWORD: 证书密码
# - APPLE_PROVISIONING_PROFILE_BASE64: Provisioning Profile 的 Base64 编码
# - KEYCHAIN_PASSWORD: 临时钥匙串密码 (可以是任意字符串)
# - APPLE_TEAM_ID: Apple Developer Team ID

name: iOS Build

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      build_type:
        description: '构建类型'
        required: true
        default: 'ad-hoc'
        type: choice
        options:
          - ad-hoc
          - development
  # 推送到 main 分支时触发
  push:
    branches:
      - main
    paths:
      - 'ios/**'
      - 'src/**'
      - 'package.json'
  # PR 时触发 (仅构建，不导出 IPA)
  pull_request:
    branches:
      - main

env:
  # 项目配置
  SCHEME: LxMusicMobile
  WORKSPACE: ios/LxMusicMobile.xcworkspace
  CONFIGURATION: Release
  
jobs:
  build-ios:
    name: Build iOS App
    runs-on: macos-14  # macOS Sonoma with Xcode 15
    
    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. 安装 Node 依赖
      - name: Install Node dependencies
        run: npm ci

      # 4. 设置 Ruby (用于 CocoaPods)
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # 5. 安装 CocoaPods
      - name: Install CocoaPods
        run: |
          gem install cocoapods
          cd ios && pod install --repo-update

      # 6. 缓存 Pods
      - name: Cache Pods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      # 7. 设置代码签名证书 (仅在有 secrets 时执行)
      - name: Install Apple Certificate
        if: github.event_name != 'pull_request'
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # 创建临时目录
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          # 解码证书
          echo -n "$APPLE_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          
          # 创建临时钥匙串
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # 导入证书到钥匙串
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # 允许 codesign 访问钥匙串
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

      # 8. 安装 Provisioning Profile
      - name: Install Provisioning Profile
        if: github.event_name != 'pull_request'
        env:
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # 创建 Provisioning Profiles 目录
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # 解码并安装 Provisioning Profile
          PROFILE_PATH=~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          echo -n "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode -o "$PROFILE_PATH"

      # 9. 更新项目配置 (设置 Team ID)
      - name: Update Project Settings
        if: github.event_name != 'pull_request'
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # 更新 project.pbxproj 中的 DEVELOPMENT_TEAM
          sed -i '' "s/DEVELOPMENT_TEAM = \"\"/DEVELOPMENT_TEAM = \"$APPLE_TEAM_ID\"/g" ios/LxMusicMobile.xcodeproj/project.pbxproj
          
          # 更新 ExportOptions 中的 teamID
          sed -i '' "s/YOUR_TEAM_ID/$APPLE_TEAM_ID/g" ios/ExportOptions-AdHoc.plist
          sed -i '' "s/YOUR_TEAM_ID/$APPLE_TEAM_ID/g" ios/ExportOptions-Development.plist

      # 10. 构建 iOS 应用 (仅编译，用于 PR 验证)
      - name: Build iOS (Compile Only)
        if: github.event_name == 'pull_request'
        run: |
          xcodebuild \
            -workspace $WORKSPACE \
            -scheme $SCHEME \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            build \
            CODE_SIGNING_ALLOWED=NO

      # 11. Archive iOS 应用
      - name: Archive iOS App
        if: github.event_name != 'pull_request'
        run: |
          xcodebuild \
            -workspace $WORKSPACE \
            -scheme $SCHEME \
            -configuration $CONFIGURATION \
            -archivePath $RUNNER_TEMP/LxMusicMobile.xcarchive \
            archive

      # 12. 导出 IPA
      - name: Export IPA
        if: github.event_name != 'pull_request'
        run: |
          # 确定导出类型
          BUILD_TYPE="${{ github.event.inputs.build_type || 'ad-hoc' }}"
          
          if [ "$BUILD_TYPE" = "development" ]; then
            EXPORT_OPTIONS="ios/ExportOptions-Development.plist"
          else
            EXPORT_OPTIONS="ios/ExportOptions-AdHoc.plist"
          fi
          
          xcodebuild \
            -exportArchive \
            -archivePath $RUNNER_TEMP/LxMusicMobile.xcarchive \
            -exportPath $RUNNER_TEMP/export \
            -exportOptionsPlist $EXPORT_OPTIONS

      # 13. 上传 IPA 作为 Artifact
      - name: Upload IPA Artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: LxMusicMobile-${{ github.sha }}
          path: ${{ runner.temp }}/export/*.ipa
          retention-days: 30

      # 14. 清理钥匙串
      - name: Cleanup Keychain
        if: always() && github.event_name != 'pull_request'
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
